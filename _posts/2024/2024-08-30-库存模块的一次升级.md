---
layout: post
title: "库存模块的一次升级"
description: "将原系统单体库存拆分为微服务"
date: 2024-08-30
categories: [架构设计,开发经验]
tags: [开发]
pin: true
math: true
mermaid: true
#image:
 # path: {{site.url}}/pics/kucun.png
 # alt: 库存设计
---
# 异步高效库存设计
## 背景
针对物流行业，库存管理，设计高效库存处理逻辑，在保证库存准确率的情况下提高系统性能
## 场景设计：
1. 系统设计 接单层、订单模块、库存模块（后续模块不包含）
2. 配合使用使用中间件，rocketmq、redis锁
3. 各模块使用异步调用，增加系统处理速度

## 异常考虑情况：
1. 订单保存失败，未调用库存模块
2. 订单调用库存模块，库存异常
3. 订单调用库存模块，库存成功，但订单回写库存信息失败
4. 流出处理同2、3情况
5. 先来出库流水，后来入库流水 






![Desktop View]({{site.url}}/pics/kucun.png){: width="700" height="400" }



## 设计效果：
1. 订单相关异常，通过接单层补偿出发，只有订单完全创建成功才结束
2. 订单调用库存异常相关，使用redis锁+库存操作日志表来判断是否库存操作成功，防止二次消费
3. 所有补偿都从上游触发
